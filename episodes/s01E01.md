# S01E01 - Le début d'une aventure 

## Synopsis
Chaque histoire a un début, au menu pour cet épisode : un message myterieux, un nouveau workload à déployer et peu de temps. 

## Remerciements
 - Thibault CORDIER (code contribution - nginx, systemd config)
 - Brian LIN (code contribution - guestbook app)

## Les étapes

 * Choose a region (look at cost, latency, your location, customer's location, etc.)
 * Deploy ec2 instance (Amazon Linux with ssm role and no key pair) - allow port 8080 and 80 as inbound rules to a security group
 * Log in to the EC2 instance using System Manager - Session Manager 
 * Switch user
 
 ```console
 $ sudo su - ec2-user
```

 * Update all packages
 
 ```console 
 $ sudo yum update -y
```

 * Install node (https://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/setting-up-node-on-ec2-instance.html)
 
 ```console 
 $ curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.34.0/install.sh | bash
 $ echo 'export NVM_DIR="/home/ec2-user/.nvm"' >> /home/ec2-user/.bashrc
 $ echo '[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"  # This loads nvm' >> /home/ec2-user/.bashrc
```

* Dot source the files to ensure that variables are available within the current shell

 ```console 
 $ . /home/ec2-user/.nvm/nvm.sh
 $ . /home/ec2-user/.bashrc
 $ nvm install node
```

 * Deploy code
 
 ```console  
 $ cd /opt
 $ sudo mkdir guestbook
 $ cd guestbook/
```

 * Clone repo
 
 ```console  
 $ sudo yum install git -y
 $ sudo git clone https://github.com/alfallouji/LIVE-CODING
```

 * change owner & restructure folder
 
 ```console  
 $ sudo mv LIVE-CODING/guestbook-app app
 $ sudo rm LIVE-CODING/ -R
 $ sudo chown ec2-user:ec2-user /opt/guestbook/ -R
```

 * Setup db
 
 ```console  
 $ sudo yum install -y mariadb-server
```

 * Deploy DB and schema
 
 ```console  
 $ sudo systemctl enable mariadb
 $ sudo systemctl start mariadb
 $ sudo mysqladmin -u root password "chips"
 $ sudo mysql -h localhost -u root -p -e "CREATE DATABASE guestbook"
 $ sudo mysql -h localhost -u root -p guestbook < database/schema_init.sql
```

 * Create new user
 
 ```console  
 $ mysql -uroot -p -e "create user 'guestbook'@'localhost' IDENTIFIED BY 'chips'"
```

 * Grant privileges
 
 ```console  
 $ mysql -uroot -p -e "grant all privileges on guestbook.* TO 'guestbook'@'localhost'"
```

 * Install node packages
 
 ```console  
 $ npm install
```

 * Configure the app
 
 ```console  
 $ cp conf/guestbook.json.default conf/guestbook.json
 ```
 
 * Edit the file and adjust folder database settings accordingly

 * Test the app (go to : http://replace-by-the-ec2-ip-address:8080)
 
  ```console 
 $ PORT=8080 bin/www
 ```

 * Install it as a service via systemd
 
```console 
 $ chmod +x setup/start.sh
```

 * Edit paths inside guestbook service and configure service with systemd
```console 
 $ sudo vi setup/guestbook.service
 $ sudo cp guestbook.service /etc/systemd/system/
 $ sudo systemctl daemon-reload
 $ sudo systemctl enable guestbook.service
 $ sudo systemctl start guestbook
```

 * Read logs from the service (if needed)
 
```console
 $ journalctl -u guestbook
```

 * Install Nginx
 
```console
 $ sudo amazon-linux-extras install nginx1.12
 $ sudo cp /etc/nginx/nginx.conf /etc/nginx/nginx.conf.bak ## backup
 $ sudo cp nginx.conf /etc/nginx/nginx.conf
 ```

 * Edit nginx.conf (adjust following section) :
 
```console  
  location / {
     proxy_pass http://127.0.0.1:8080;
  }
```

 * Enable and start nginx (enable will autostart it on reboot)
 
```console  
 $ sudo systemctl enable nginx
 $ sudo systemctl restart nginx
```
 
 * Update security group to allow port 80 & go to : http://replace-by-the-ec2-ip-address
